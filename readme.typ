#import "./lib.typ": *

#show: project.with(
  title: "《交通规划原理》课程报告",
  author: "倪子煊2023091203002",
  date: auto,
  // abstract: [
  //   摘要内容...
  // ],
  // keywords: ("关键词1", "关键词2")
)

= 交通分配问题的背景与意义

自20世纪50年代美国开展底特律、芝加哥等大都市圈的交通调查与规划研究以来，以“四阶段法”（交通产生、交通分布、方式划分、交通流分配）为核心的交通需求预测体系逐步确立。其中，#strong[交通流分配]作为核心技术环节，旨在将预测得到的起讫点（OD）交通量，根据已知的道路网描述，按照符合实际的规则分配到路网中的各条道路上，进而求出路网中各路段的交通流量与行程时间，为交通网络的使用状况分析与评价提供依据。

早期的交通分配研究多采用#strong[全有全无（All-or-Nothing）]方法，即假设路网不存在交通拥挤，路段阻抗（行驶时间）固定不变，一个OD对间的全部流量均被分配至唯一的“最短径路”上。这种分配方法在简单的非拥挤路网上能取得较好的分配效果。

然而，当该理想化模型在应用于城市内部拥挤路网时，其结果与实际情况存在显著偏差。现实中，随着路段流量的增加，交通拥挤导致行驶阻抗上升，出行者会在感知到的多条可行路径中进行权衡选择。

为科学描述这一交互机制，`Wardrop`于1952年提出了著名的网络平衡分配第一、第二定理，奠定了现代交通分配理论的基础。其中，#strong[第一原理（用户均衡，`User Equilibrium, UE`）]指出：当网络达到平衡时，每个OD对之间所有被使用的路径具有相等且最小的行驶时间；未被使用的路径其行驶时间不小于该最小值。这一定理深刻揭示了个体出行决策与系统整体状态之间的内在联系。

在模型实现层面，路段阻抗通常通过#strong[路阻函数]来刻画。被广泛应用的路阻函数，是由美国道路局BPR（Bureau of Public Roads）开发的，其函数形式为：

$ t_a = t_0 [1 + α (q_a / c_a)^β] $

其中 $t_a$为路段a上的阻抗，$t_0$ 为零流阻抗，即自由流行驶时间，$q_a$ 为路段a上的流量，$c_a$ 为路段a的通行能力，α 和 β 为阻滞系数。该函数有效反映了交通拥挤对出行成本的影响。

随着研究的深入，学者们认识到出行者对阻抗的感知存在随机性，进而发展出#strong[随机用户均衡（SUE）]理论。而近年来，面对日益复杂的交通系统，#strong[动态交通分配]、#strong[多方式网络建模]等也成为新的研究热点。尽管如此，基于Wardrop UE原理的静态确定性分配模型，因其理论严谨、计算相对成熟，仍是当前交通规划实践中的主流方法。

因此，本报告旨在复现并实现从基础到进阶的典型交通分配算法（全有全无、增量分配、Frank-Wolfe用户均衡），通过在标准测试路网上进行对比分析，深入理解不同模型对路网拥挤效应和出行者路径选择行为的刻画能力，从而为交通规划与管理决策提供科学支撑。


= 软件的功能模块划分和各模块设计思路

本测试软件采用“高内聚、低耦合”的模块化架构，依据功能职责将代码划分为六个核心模块。各模块通过清晰的函数接口交互，共同完成从数据输入到结果输出的完整流程。具体划分如下：

#strong[（1）数据加载与路网构建模块 {`data_load.py`}]

该模块负责初始化路网与需求数据：
- load_network_and_demand()：读取 JSON 格式的 `network.json` 和 `demand.json` 文件；
- build_graph_and_links()：根据节点坐标计算路段欧氏长度l，推导自由流行驶时间 $t_0 = l / v_max$，并将每条无向路段扩展为两条有向边（支持双向通行），最终构建邻接表形式的图结构 `graph` 和包含物理属性的边列表 `links`。

#strong[（2）基础算法工具模块 {`assignment_utils.py`}]

提供通用的路径搜索与流量分配原语：
- dijkstra_shortest_path()：基于给定阻抗向量，使用 `Dijkstra` 算法求解最短路径，并返回路径上的边索引序列；
- all_or_nothing_assignment()：调用上述最短路径函数，对所有 OD 对执行一次全有全无分配，返回各边流量向量。此函数在 AON 中被调用一次，在 IA 与 FW 中被多次调用。

#strong[（3）交通流计算与评估模块 {`calculate.py`}]

封装所有与交通流相关的数学计算：
- get_link_travel_time()：计算 路阻函数
#align(center)[$ t(q) = t_0 (1 + q/c)^2 $]

- get_total_travel_time()：计算 路网总出行时间  `total_travel_time(TTT) `
#align(center)[$ T T T = sum q_a dot t_a $]
其中：
$q_a$：路段 $a$ 上的流量（辆）
$t_a$：路段 $a$ 上的行程时间（小时）


- Beckmann_function()：计算 `Frank-Wolfe` 优化问题的目标函数值；
- line_search_newton()：采用 `Newton-Raphson` 法精确求解 FW 迭代中的最优步长 $alpha$。

#strong[（4）交通分配算法模块 {`AON.py`, `IA.py`, `FW.py`}]

包含三种独立的分配策略实现，均以统一接口返回流量向量flow 与 路网总出行时间total_travel_time(TTT)：
- 全有全无分配（{`AON.py`}）：基于自由流时间 $t_0$ 执行一次 全有全无分配函数all_or_nothing_assignment()；
- 增量分配（{`IA.py`}）：将总需求等分为 $K$ 份，循环调用 AON 并累加流量，每次迭代更新阻抗；
- Frank-Wolfe 用户均衡分配（{`FW.py`}）：主循环中遍历执行 AON 方向搜索、相对间隙收敛判断、Newton 线搜索寻找最优步长 $alpha$，直至满足精度要求。

#strong[（5）可视化模块 {`visualize_network.py`}]

将分配结果转化为直观图形：
- 接收 NetworkX 有向图 {G}（每条边含有 流量Q 与 行程时间t 属性）、节点坐标 {pos_dict} 及 路网总出行时间 TTT 值；
- 自动计算线宽（对数缩放）、颜色映射（流量热力图）；
- 在每条边上叠加三行标签（路段名、流量 $q$、行程时间 $t$）；
- 绘制带色标的路网图，并在图中嵌入 TTT 数值。

#strong[（6）主程序 {`main.py`}]

整合上述模块，实现课程要求的四项核心功能验证：
- 分别构建自由流/拥堵状态下的最短路径查询；
- 单 OD 对（如 A→F）的用户均衡分析；
- 多 OD 全网分配下 AON/IA/FW 三算法对比；
- 自动调用可视化模块展示结果。

#summary[该架构设计使得算法逻辑与数据处理、可视化完全解耦，不仅便于调试与验证，也为未来扩展奠定了良好基础。]

= 开发环境与依赖

本软件基于 Python 语言开发，具体环境与依赖如下：

#strong[1.编程语言与版本]
- 语言：Python 3.8 或更高版本

#strong[2.核心依赖库 `requirements.txt`]
所有依赖均通过 {requirements.txt} 文件管理:
- {networkx==3.1}：用于构建与操作有向图结构，支持节点/边属性存储；
- {numpy==1.24.2}：提供高效的数组运算，用于流量向量与矩阵计算；
- {matplotlib==3.7.5}：实现路网拓扑的可视化，支持自定义标签、颜色映射与线宽。

上述版本组合已在 Windows 11 环境下验证兼容性。

#strong[3.安装与运行方式]
用户可通过以下步骤快速部署本软件：
(1) 克隆代码仓库至本地;
(2) 在项目根目录执行命令：
{pip install -r requirements.txt}
(3) 运行主程序：
{python main.py}

#strong[4.代码托管]
完整源代码已开源并托管于 Github 代码仓库，地址如下：
#link(
  "https://github.com/nzxQAQ/uestc-traffic-assignment-2025",
)[https://github.com/nzxQAQ/uestc-traffic-assignment-2025]



